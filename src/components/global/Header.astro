---
import { NAV_LINKS, SITE } from "../../lib/constants";
import ThemeToggle from "./ThemeToggle";
import LanguageSwitcher from "./LanguageSwitcher.astro";
import { getLangFromUrl, useTranslations, useTranslatedPath } from "../../i18n/utils";

const currentPath = Astro.url.pathname;
const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
const translatePath = useTranslatedPath(lang);

// Map href to translation keys
const navLabelKeys: Record<string, string> = {
  "/": "nav.home",
  "/about": "nav.about",
  "/projects": "nav.projects",
  "/papers": "nav.papers",
  "/blog": "nav.blog",
  "/resume": "nav.resume",
  "/contact": "nav.contact",
  "/travel": "nav.travel",
  "/cover-letter": "nav.coverLetter",
};

// Helper to get translated label
function getNavLabel(href: string): string {
  const key = navLabelKeys[href];
  if (key) {
    // @ts-ignore - dynamic key access
    return t(key) || href.slice(1) || "Home";
  }
  return href.slice(1) || "Home";
}
---

<header
  class="sticky top-0 z-50 w-full border-b border-light-border dark:border-dark-border bg-light-bg/80 dark:bg-dark-bg/80 backdrop-blur-md"
>
  <nav class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex items-center justify-between h-16">
      <!-- Logo -->
      <a
        href={translatePath("/")}
        class="font-display font-bold text-lg hover:text-accent-500 transition-colors"
      >
        {SITE.name}
      </a>

      <!-- Desktop Navigation -->
      <div class="hidden md:flex items-center gap-1">
        {
          NAV_LINKS.map((link) => {
            const translatedHref = translatePath(link.href);
            const translatedLabel = getNavLabel(link.href);
            const isActive =
              currentPath === translatedHref ||
              (link.href !== "/" && currentPath.startsWith(translatedHref));
            return (
              <a
                href={translatedHref}
                class:list={[
                  "px-3 py-2 text-sm font-medium rounded-md transition-colors",
                  isActive
                    ? "text-accent-500 bg-accent-500/10"
                    : "text-light-muted dark:text-dark-muted hover:text-light-text dark:hover:text-dark-text hover:bg-light-border/50 dark:hover:bg-dark-border/50",
                ]}
              >
                {translatedLabel}
              </a>
            );
          })
        }
        <div class="ml-2 pl-2 border-l border-light-border dark:border-dark-border flex items-center gap-2">
          <LanguageSwitcher />
          <ThemeToggle client:load />
        </div>
      </div>

      <!-- Mobile Menu Button -->
      <div class="flex md:hidden items-center gap-2">
        <LanguageSwitcher />
        <ThemeToggle client:load />
        <button
          id="mobile-menu-btn"
          type="button"
          class="p-2 rounded-md text-light-muted dark:text-dark-muted hover:text-light-text dark:hover:text-dark-text hover:bg-light-border/50 dark:hover:bg-dark-border/50"
          aria-label="Toggle menu"
          aria-expanded="false"
        >
          <svg
            class="w-6 h-6 menu-icon"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M4 6h16M4 12h16M4 18h16"></path>
          </svg>
          <svg
            class="w-6 h-6 close-icon hidden"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
    </div>

    <!-- Mobile Navigation -->
    <div id="mobile-menu" class="hidden md:hidden pb-4">
      <div class="flex flex-col gap-1">
        {
          NAV_LINKS.map((link) => {
            const translatedHref = translatePath(link.href);
            const translatedLabel = getNavLabel(link.href);
            const isActive =
              currentPath === translatedHref ||
              (link.href !== "/" && currentPath.startsWith(translatedHref));
            return (
              <a
                href={translatedHref}
                class:list={[
                  "px-3 py-2 text-sm font-medium rounded-md transition-colors",
                  isActive
                    ? "text-accent-500 bg-accent-500/10"
                    : "text-light-muted dark:text-dark-muted hover:text-light-text dark:hover:text-dark-text hover:bg-light-border/50 dark:hover:bg-dark-border/50",
                ]}
              >
                {translatedLabel}
              </a>
            );
          })
        }
      </div>
    </div>
  </nav>
</header>

<script>
  const mobileMenuBtn = document.getElementById("mobile-menu-btn");
  const mobileMenu = document.getElementById("mobile-menu");
  const menuIcon = mobileMenuBtn?.querySelector(".menu-icon");
  const closeIcon = mobileMenuBtn?.querySelector(".close-icon");

  mobileMenuBtn?.addEventListener("click", () => {
    const isOpen = mobileMenu?.classList.contains("hidden");
    mobileMenu?.classList.toggle("hidden");
    menuIcon?.classList.toggle("hidden");
    closeIcon?.classList.toggle("hidden");
    mobileMenuBtn?.setAttribute("aria-expanded", String(isOpen));
  });
</script>
